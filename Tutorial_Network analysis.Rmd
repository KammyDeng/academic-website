---
title: "Network Analysis Workshop"
author: "Jiaxin Deng"
date: "2023/03/09"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---------- Table of Contents --------------------------------------------------------------------------------------------  
---------- 1. Network analysis using R --------------------------------------------------------------  
---------- 2. Network basic------------------------------------------------------------------------------  
----------Hands-on exercises 1: Practice with example1 data--------------------------------  
---------- 3. Network comparison--------------------------------  
----------Hands-on exercises 2: Practice with example2 data--------------------------------  
---------- 4. Special issues------------------------------------------------------------------------------------------  
---------- 5. Take-away message--------------------------  
---------- 6. Resources--------------------------------------------------------------------------------  

## 1. Network analysis using R
R programming is commonly used in network psychometrics.  
Several packages for network analysis include:
`qgraph` (Epskamp et al., 2012),
`bootnet` (Epskamp et al., 2018),
`Network Comparison Test package` (NCT; van Borkulo et al., 2022),
`EstimateGroupNetwork` (Costantini & Epskamp, 2017)

## 2. Network basic
### Brif introduction
The following is an example of how a network analysis study of callous-unemotional traits was conducted (Deng et al., 2021).    
The study analyzed the network structure of the Inventory of Callous-Unemotional Traits (Wang et al. 2019) in two samples of 609 juvenile prisoners (sample 1) and 487 children (sample 2) in China.  
The example data here was randomly selected from the data of sample 2.  

This scale consist of three subscales with 24 items including 是**Callousness**, **Uncaring** and **Unemotional**.  

Next, it will show how to use the `qgraph` and `bootnet` packages to perform network analysis of the data.  

### 2.0.1 Install and load packages
First, you need to install and load the packages.  

```{r load1, warnings = FALSE,message=FALSE}
library(readxl)#install.packages("readxl") for installation
library(qgraph)#install.packages("qgraph")
library(bootnet)#install.packages("bootnet")
library(networktools)
```

### 2.0.2 Data import
Since the data used in the example is not from the package, it needs to be imported first.  
The `readxl` package is used to read and import the data in the .xlsx format. Use the `read_excel()` function to read the data with the following code:  

```{r load2, warnings = FALSE}
#getwd()#check working directory
#setwd("/Users/apple/network analysis workshop")#set working directory
#read data
data1<- read_excel("example1_data_c.xlsx")#demo data
head(data1)[1:5,]
colnames(data1)
```

Generally, four steps of analysis were carried out in the following sections.  
+ Network Estimation
+ Network Inference: Centrality indices
+ Network Stability
+ Network Comparison

### 2.1 Network estimation
Let's start with the graph of network structure.  

#### 2.1.1 Basic graph
The graph is estimated and plotted using `qgraph()`.  
Note that the input in `qgraph()` can be either a weights matrix or an edgelist. Therefore, create a weights matrix or an edgelist first, for example `cor_auto()` to compute a correlation matrix.  

```{r q1-1, warnings = FALSE, cache=TRUE, message=FALSE}
c1=cor_auto(data1)#Compute correlation matrix
qgraph<-qgraph(c1)#no grouping
```

```{r q1-2, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph<-qgraph(cor_auto(data1))#
```

The white circles in the figure indicate the nodes in the network, with 24 nodes in total, corresponding to the 24 items of the scale. This is a network  based on the correlation matrix.  

As shown in the figure above, this is a network without defining groups. If you need to differentiate the nodes, you can use `groups` to set the grouping of each node.  
For example, define the grouping of the 24 items of the scale.  

```{r q2groups, warnings = FALSE}
ICU24groups<-c("Unemotional","Callousness","Uncaring","Callousness",
               "Uncaring","Unemotional","Callousness",
               "Callousness","Callousness",
               "Callousness","Callousness","Callousness","Uncaring","Unemotional",
               "Uncaring","Uncaring","Uncaring","Callousness","Unemotional","Callousness",
               "Callousness","Unemotional","Uncaring","Uncaring")

```

```{r q3qgroup, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph(cor_auto(data1), groups= ICU24groups)#with groups
```

As shown in the figure, the left side is the graph of network structure, and the right side is the legend of the graph. There are three colors of nodes in the network, including red, green and blue corresponding to callousness, uncaring and unemotional.  
In addition to the nodes, it can be observed that the edges between the different nodes showed both green and red lines. Generally, the green lines indicate positive correlations and the red lines indicate negative correlations. For example, ICU15 and ICU23 showed a positive correlation in the figure.  

#### 2.1.2 Customized graph 
In addition to the grouping, you can also set the format of the graph with other parameters.  

##### (1) Layout
Use `layout` to change the shape of the graph.  

```{r q4group1, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph(cor_auto(data1), groups=ICU24groups, layout= "spring") #spring
```

```{r q5group1, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph(cor_auto(data1), groups=ICU24groups, layout= "circle")#circle
```

Also, you can use `"palette="` and `"theme="` to change the color of the nodes. Note that `"palette="` needs to be used together with `"groups="`.  

```{r q6group1, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph(cor_auto(data1), groups=ICU24groups,palette="colorblind",layout= "spring")#palette="colorblind"
```

```{r q6group2, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph(cor_auto(data1), groups=ICU24groups,palette="pastel",layout= "spring")#"palette="pastel"
```

```{r q6group3, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph(cor_auto(data1), groups=ICU24groups,palette="gray",layout= "spring")#"palette ="gray"
```

In addition to change the color, you can also adjust the rendering of the result graph for black and white printing. Use the `makeBW()` function to set the graph for black-and-white printing mode, which is suitable for black-and-white printing graph, so that you can see the differences in the network. The network in BW mode can be seted with the following characteristics:  
1) the solid line refers to a positive correlation while the dashed line refers to a negative correlation.
2) with the previous colors changing, it can also increase the distinction between lines, such as red nodes are diagonal lines, green nodes are vertical lines, blue nodes are horizontal lines.  

```{r q6group4, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph=qgraph(cor_auto(data1), groups=ICU24groups,layout= "spring")#negDashed = TRUE
makeBW(qgraph)#plot in black and white mode
```

##### (2) Common arguments
In addition to changing the layout of the graph, you can also adjust the presentation of a particular aspect and the way it is presented. For example, node size, node borders, edge colors, the edge weights,legend position and its size, etc.  

Here is a list of some parameters that can be used to customize the graph.  
+ `"minimum"`: the number of nodes to be rendered according to the degree of association between them  
+ `"borders"`: whether to render the node borders or not  
+ `"vsize"`: change the size of the node  
+ `"legend"`: whether to render the legend and define its position  

##### 1) nodes
Common parameters involved in nodes include:
vsize, node.width,node.height,nodeNames, borders,border.color,border.width,shape,labels,label.cex, etc.  
The options of shape can be circle, square, triangle, rectangle, which can be adjusted according to the actual situation of node content.  
When you need to customize the graph, it can use the above parameters to customize the settings. The code is displayed as follows:  

```{r q7group3, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph(cor_auto(data1),groups=ICU24groups, 
       layout= "spring",palette="colorblind",
       vsize=3,borders=TRUE,shape="rectangle",node.width=2,node.height=1,
       legend=TRUE
       )
```

##### Specific description of nodes
It can also show a more specific illustrations for the reader to understand each node.  

```{r qlabel1, warnings = FALSE, cache=TRUE, message=FALSE}
Labels<-colnames(data1)
Names<-c("Expresses feelings openly","Does not know right from wrong",
         "Concerned about school work","Does not care who is hurt",
         "Feels bad or guilty","Does not show emotions","Does not care about being on time",
         "Concerned about feelings of others","Does not care if in trouble",
         "Does not let feelings control","Does not care about doing well",
         "Seems very cold and uncaring","Easily admits to being wrong",
         "Easy to tell how I am feeling","Always tries the best",
         "Apologizes to persons","Tries not to hurt others feelings",
         "Shows no remorse","Expressive and emotional",
         "Does not put the time into things","Feelings of others unimportant",
         "Hides feelings from others","Work hard on everything",
         "Does things to make others feel good")
q_cor_auto1<-qgraph(cor_auto(data1),groups=ICU24groups,cut=0.4,vsize=6,
                   legend=TRUE,borders=TRUE,layout="spring",
                   palette="colorblind",
                   legend.cex=0.25,label.cex=1,
                   labels=Labels,nodeNames=Names, mar=c(4,1,2,2))
```

##### 2) Edge
Common parameters involved in edges include: posCol, negCol, negDashed, minimum, etc.  

```{r q7group-edge, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph(cor_auto(data1),groups=ICU24groups, 
       cut=0.4,vsize=6,
                   legend=TRUE,borders=TRUE,layout="spring",
                   palette="colorblind",
                   legend.cex=0.5,label.cex=1,
       minimum=0.2,
       negDashed=TRUE,
       posCol="#009900",negCol="#BF0000")#customized color
```

##### 3) Options for correlation/covariance matrices
Use `graph` to set the types, including a correlation network, a partial correlation network and an optimal sparse estimate of the partial correlation matrix.    

```{r q9group4cor1, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph_cor=qgraph(cor_auto (data1), groups=ICU24groups, layout="spring",
     vsize=6,minimum=0.1,
                   legend=TRUE,borders=TRUE,layout="spring",
                   palette="colorblind",
                   legend.cex=0.5,label.cex=1,graph="cor")#Plot a correlation network
```

```{r q9group4, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph_pcor=qgraph(cor_auto (data1), groups=ICU24groups, layout="spring",
     vsize=6,minimum=0.1,
                   legend=TRUE,borders=TRUE,layout="spring",
                   palette="colorblind",
                   legend.cex=0.5,label.cex=1,graph="pcor")#Plot a partial correlation network
```

Show the significant edges using minimum.  

```{r q9group4cor, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph(cor_auto (data1), groups=ICU24groups, layout="spring",
     vsize=6,minimum='sig',
                   legend=TRUE,borders=TRUE,layout="spring",
                   palette="colorblind",
                   legend.cex=0.5,label.cex=1,graph="pcor",sampleSize = nrow(data1))#Plot a partial correlation network
```

Define sampleSize when graph = "glasso".  

```{r q9groupglasso, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph_glasso=qgraph(cor_auto (data1), groups=ICU24groups, layout="spring",vsize=6,minimum=0.1,
                   legend=TRUE,borders=TRUE,layout="spring",
                   palette="colorblind",
                   legend.cex=0.5,label.cex=1,
       graph="glasso",sampleSize = nrow(data1))#used sampleSize when graph = "glasso" 
```

According to the above figure, there are some differences between types of networks, for example,the network based on partial correlation matrix presents fewer edges. The network based on correlation matrix may have some spurious relationships, i.e., some associations between nodes are established by a third node, not two directly connected edges.  

##### (3) Others
Use `title` to add the title if need.  

```{r q8group3, warnings = FALSE, cache=TRUE, message=FALSE}
qgraph(cor_auto(data1),groups=ICU24groups, layout= "spring",minimum=0.15,vsize=5,legend=TRUE,borders=TRUE,palette="colorblind",title="ICU-24 item-level network")
```

Finally, the graph can be saved using `filetype` for setting the file type and the path where the file is located.  

```{r qgroup4c, warnings = FALSE, cache=TRUE, message=FALSE}
q_cor_auto1<-qgraph(cor_auto(data1),groups=ICU24groups,minimum=0.15,cut=0.4,vsize=6,
                   legend=TRUE,borders=TRUE,layout="spring",
                   palette="colorblind",
                   legend.cex=0.25,label.cex=1,
                   labels=Labels,nodeNames=Names, 
                   mar=c(4,1,2,2),#margin：t, r, b, l
                   height=5,width=5,#size of figure
                   filetype="jpg",filename="q_cor_auto1")
```

#### 2.1.3 Network estimation using `estimateNetwork`
+ In addition to using `qgraph` for network estimation, it can also use `estimateNetwork` function in the `bootnet` package with types of networks.  

##### (0) Correlation matrix

```{r network-est, warnings = FALSE, cache=TRUE, message=FALSE}
Network <- estimateNetwork(data1, default = "cor") #default = "cor"-- Correlation matrix
plot(Network, layout = 'spring',groups=ICU24groups,minimum=0.15,cut=0.4,vsize=6,
                   legend=TRUE,borders=TRUE,
                   palette="colorblind",
                   legend.cex=0.25,label.cex=1,height=5,width=5,
                   labels=Labels,nodeNames=Names, mar=c(4,1,2,2))
```

##### (1) Continuous data：GGM

```{r network-est-con, warnings = FALSE, cache=TRUE, message=FALSE}
Network_glasso1 <- estimateNetwork(data1, default="EBICglasso") #default
Network_glasso2 <- estimateNetwork(data1, default = "EBICglasso",corMethod = "cor_auto")#glasso using cor_auto
Network_glasso3 <- estimateNetwork(data1, default="EBICglasso",corMethod = "spearman")#glasso using spearman

### First, how similar are polychoric and Pearson?
c1 <- cor(data1)#Pearson
c1b <- cor_auto(data1)#polychoric
cor(c1[lower.tri(c1)], 	c1b[lower.tri(c1b)], 	method="spearman") #0.9894448
cor(c1[lower.tri(c1)], 	c1b[lower.tri(c1b)], 	method="pearson") #0.9893105

#plot the graph
plot(Network_glasso2, layout = 'spring',groups=ICU24groups,vsize=6,
                   legend=TRUE,borders=TRUE,minimum=0,
                   palette="colorblind",
                   legend.cex=0.25,label.cex=1,height=5,width=5,
                   labels=Labels,nodeNames=Names, mar=c(4,1,2,2))
```


##### (2) Mixture data：Mixed graphical model
This type is suitable for the case which different types of data are combined for the analysis.  

```{r network-est-mgm, warnings = FALSE, cache=TRUE, message=FALSE}
#Just show the example code here.
#Network_MGM <- estimateNetwork(data1, default="mgm") #Mixed graphical model 

#plot the graph
#plot(Network_MGM, layout = 'spring',groups=ICU24groups,vsize=6,
#                   legend=TRUE,borders=TRUE,minimum=0,
#                   palette="colorblind",
#                   legend.cex=0.25,label.cex=1,height=5,width=5,
#                   labels=Labels,nodeNames=Names, mar=c(4,1,2,2))
```

##### (3) Dichotomous data: Ising model

```{r network-est-ising, warnings = FALSE, cache=TRUE, message=FALSE}
#Just show the example code here.
#Network_Ising <- estimateNetwork(data, default="IsingFit") 

#plot the graph
#plot(Network_Ising, layout = 'spring',groups=ICU24groups,vsize=6,
#                   legend=TRUE,borders=TRUE,
#                   palette="colorblind",
#                   legend.cex=0.25,label.cex=1,height=5,width=5,
#                   labels=Labels,nodeNames=Names, mar=c(4,1,2,2))
```


### 2.2 Network inference: Central indices
#### 2.2.1 Common indices
Central indices of each node can be calculated to understand the importance of the nodes in the network. It can be calculated by the function `centrality_auto`. If you want to visualize the results, you can use the function `centralityPlot` to plot the results.   

```{r centrality1, warnings = FALSE, cache=TRUE, message=FALSE}
centrality_auto(q_cor_auto1)#calculate the centrality indices
centralityPlot(q_cor_auto1,include=c("Strength","Closeness","Betweenness"))#include three statistics using raw scores
centralityPlot(q_cor_auto1,include=c("Strength","Closeness","Betweenness"),
               scale = "z-scores")#using z scores

#add Expected influence
centralityPlot(q_cor_auto1,include=c("Strength","Closeness","ExpectedInfluence"),
               scale = "z-scores")
```

The above figure shows the visualization of all nodes in the network on the central indices of **strength**, **closeness**, and **betweenness**. As shown in the figure, the vertical axis represents all nodes and the horizontal coordinates represent the standardized scores of node centrality.  

In addition to this, the order of the nodes on the vertical axis can be specified using `orderBy`. The default is **alphabetical order**, but if you need to order the nodes by one central index, you can adjust it with `orderBy="Strength"`.

```{r centrality3, warnings = FALSE}
centralityPlot(q_cor_auto1,include=c("Strength","Closeness"),
               scale = "z-scores",orderBy="Strength")#node order
```

If you want to compare the the central indices of different network, you can use the code like this:  

```{r centrality4, warning=FALSE, message=FALSE}
centralityPlot(list(cor=qgraph_cor,
                    pcor = qgraph_pcor, glasso=qgraph_glasso),
               include=c("Strength","Closeness","Betweenness"),
scale = "z-scores")
```

```{r centrality-comparison, warning=FALSE, message=FALSE}
qgraph::centralityPlot(list(correlation_network=Network,EBICglasso_default= Network_glasso1,EBICglasso_corauto= Network_glasso2, EBICglasso_spearman=Network_glasso3),include=c("Strength","Closeness","Betweenness"), scale = "z-scores",labels=Labels)
```

From the figure, it can be seen that the correlation matrix and glasso networks are relatively close, and the pcor network are more different. Therefore, it should be paid attention to consider the type of networks possibly with variable type and sample size.  
Finally, you can save the results of centrality indices using `pdf()`.  

```{r centrality5, warning=FALSE, message=FALSE}
pdf("Fig_centralityPlot.pdf", width=10, height=10)
centralityPlot(q_cor_auto1,include=c("Strength","Closeness","Betweenness"),
               scale = "z-scores")#
dev.off()
```

#### 2.2.2 Bridge centrality
Bridge centrality can be analysed using the `bridge` function in `networktools` package.  

```{r bridge, warning=FALSE, message=FALSE}
library(networktools)
head(depression)
graph1 <- qgraph::qgraph(cor(depression))#cor
graph1 <-qgraph(cor_auto(depression), layout="spring",vsize=6,minimum=0.1,
                   borders=TRUE,
                   palette="colorblind",
                   label.cex=1,
       graph="glasso",sampleSize = nrow(depression))#glasso

bridge <- bridge(graph1, communities=c('1','1','2','2','2','2','1','2','1'))
bridge

#pdf("Fig_bridge.pdf", width=10, height=10)
plot(bridge, order="value", zscore=TRUE,include=c("Bridge Strength", "Bridge Betweenness"))
plot(bridge, order="value", zscore=TRUE,include=c("Bridge Strength", "Bridge Betweenness"),color=TRUE)#color for catogory
#dev.off()

```

### 2.3 网络结构的准确性分析
The accuracy and stability of network analysis might be influenced by the sample size. Therefore, it needs to analyse the accuracy of network after network estimation. The accuracy of network analysis includes three ways using `bootnet` package (Epskamp, Borsboom & Fried, 2018).  
+ Bootstrapped confidence intervals (CI) of edge–weight
+ Stability of centrality indices
+ Bootstrapped the paired differences of edge–weights and node centrality

Next, this tutorial will use data1 as an example to introduce how to use `bootnet` for these three ways.  

*Notes that you need to estimate the network using `estimateNetwork` before the accuracy analysis of networks.*

#### (1) Bootstrapped CI of edge–weight

```{r ci, warnings = FALSE, cache=TRUE, message=FALSE,fig.width=10,fig.height=10}
Results1 <- bootnet(Network, statistics=c("strength","closeness","betweenness","edge"), nBoots = 500, nCores = 5) 
#nBoots: number of bootstraps
#nCores: number of cores to use
plot(Results1, labels = FALSE, order = "sample")#orders the edge-weights from the most positive to the most negative edge-weight in the sample network.
```

As shown in the figure, the red line indicates the sample values and the gray area the bootstrapped CIs. Each horizontal line represents one edge of the network. The overlapping confidence intervals of the edge weights represent non-significant differences in the edge-weights.

#### (2) Bootstrapped the paired differences of edge–weights and node centrality

```{r diff1, warnings = FALSE, cache=TRUE,fig.width=15,fig.height=15}
plot(Results1, "strength", plot = "difference")#strength differences
plot(Results1, "closeness", plot = "difference")#closeness differences
plot(Results1, "betweenness", plot = "difference")#betweenness differences
```

```{r diff2, warnings = FALSE, cache=TRUE,fig.width=20,fig.height=20}
pdf("Fig_edgeweightdiff.pdf", width=50, height=50)
plot(Results1, "edge", plot = "difference", onlyNonZero = TRUE, order = "sample")#edge differences
#onlyNonZero sets that only edges are shown that are nonzero in the estimated network
dev.off()
```

These two figures show the results of the difference test between paired edges and nodes in the network. The vertical and horizontal axes are the edges or nodes in the network.  
The black boxes indicate that there is a significant difference between them, while the white boxes indicate that it is non-significant between them, and the middle diagonal line indicates the specific value of the edge or node.  
As shown in the figure, ICU21 and ICU20 had a greater number of significant differences from each other than other nodes.  

Use `differenceTest()` to set `measure` if need to compare any two nodes or edges.  

```{r diff3, warnings = FALSE, cache=TRUE, message=FALSE}
#for nodes
differenceTest(Results1, "CA_ICU2", "CA_ICU12", "strength")
differenceTest(Results1, "CA_ICU2", "CA_ICU18", "strength")
#for edges
differenceTest(Results1, "CA_ICU2--CA_ICU18", "CA_ICU2--CA_ICU12", "edge")
```


#### (3) Stability of centrality indices

```{r stability, warnings = FALSE, cache=TRUE, message=FALSE,fig.width=5,fig.height=5}
Results2 <- bootnet(Network, statistics=c("strength","closeness","betweenness"), nBoots = 500, nCores = 3, type = "case") 

plot(Results2 ,statistics=c("strength","closeness","betweenness"))#
corStability(Results2)#Compute CS-coefficients
#CS-coefficient should not be below 0.25, and preferably above 0.5.
```

As shown in the figure, the vertical axis is the degree of correlation between the original sample and the estimated results from the reduced sample size, and the horizontal axis is the number of samples. The different colored lines in the figure indicate the specific values of nodes centrality, and the different colored ranges represent the corresponding confidence intervals.  
The stability of the centrality indices is gradually decreasing as the sample size decreases especially the betweenness.  

## 3. Network comparison

Longitudinal networks or multigroup networks are basically the comparisons between networks, including:  
(1) Comparison across time: node comparisons at different times, such as:  
 + Does the centrality of nodes change from time-point 1 to time-point 4?  
 + If it changes, how does it change?  

(2) Cross-sample comparison: comparison between sample characteristics, such as gender, cultural background, sample type, etc.  
+ Gender differences  
+ Cultural differences   
+ Sample type differences  

### Brif introduction
The following is an example of child psychopathy network to present how to analysis a longitudinal network analysis study (Zhang et al., 2022). This study used **longitudinal design** to collect data and explored the stability of the network structure in the temporal period, i.e., **whether the network structure changes over time**.  

Compared with the previous cross-sectional study, **this study was based on the comparison of the sample at different time-points**.

This study used 268 students from an elementary school in Guangdong Province and used the Chinese version of the Child Problematic Traits Inventory (Wang et al., 2018) to assess child psychopathy.  

The 28-item consist of three subscales, **Callous-unemotional (CU) traits**, **Grandiose-deceitful (GD)**, **Impulsive-Need for Stimulation (INS)**. Items are scored on a 4-point Likert.  

Data in this study were collected at one-year intervals from 2016 to 2019, for a total of **four waves data collections**. Basically, data analysis was to analyze the data at each time point separately and then compare the results of the network structure at each time-point.  

Next, the following shows how to perform network analysis using the demo data.  

### 3.0.1 Installation and load packages
Load another package named `NetworkComparisonTest` for network comparison.  

```{r load library, warnings = FALSE,message=FALSE}
library(NetworkComparisonTest)#install.packages("NetworkComparisonTest")
```

#### 3.0.2 Data import
```{r load3, warnings = FALSE, cache=TRUE, message=FALSE}
Data1<- read_excel("example2_Data1_t1.xlsx")#demo data1
Data2<- read_excel("example2_Data2_t2.xlsx")#demo data2
Data3<- read_excel("example2_Data3_t3.xlsx")#demo data3
Data4<- read_excel("example2_Data4_t4.xlsx")#demo data4
```

### 3.1 Network estimation
The basic analysis idea is to first estimate the network for the data collected at each time point separately and plot the graph.  

```{r longnetwork, warnings = FALSE, cache=TRUE, message=FALSE}
Network1<-bootnet::estimateNetwork(Data1,default = "cor")#Time 1
Network2<-bootnet::estimateNetwork(Data2,default = "cor")#Time 2
Network3<-bootnet::estimateNetwork(Data3,default = "cor")#Time 3
Network4<-bootnet::estimateNetwork(Data4,default = "cor")#Time 4
```

```{r longnetworkgroup, warnings = FALSE}
groups<-c("INS","CU","INS","CU","GD","INS","GD",
          "CU","GD","INS","CU","INS","CU","INS",
          "GD","INS","CU","GD","INS","CU","GD",
          "CU","INS","GD","CU","GD","CU","INS")
Labels<-colnames(Data1)
Names<-c("Likes change and that things happen all the time",
         "Seldom expresses sympathy for others",
         "Often has difficulties with awaiting his/her turn",
         "Usually does not seem to share others?? joy and sorrow",
         "Lies often to avoid problems",
         "Seems to do certain things just for the thrill of it",
         "Seems to see himself/herself as superior compared to others",
         "Never seems to have bad conscience for things that he/she has done",
         "Often lies to get what he/she wants",
         "Provides himself/herself with different things very fast and eagerly",
         "Often seems to be completely indifferent when other children are upset",
         "Often does things without thinking ahead",
         "Does not become upset when others are being hurt",
         "Often consumes things immediately rather than saving them",
         "Seems to lie more than other children of the same age",
         "Seems to have a great need for change and excitement",
         "Seldom remorseful when he/she has done something not allowed",
         "Is often superior and arrogant toward others",
         "Does not like waiting",
         "Often does not seem to care about what other people feel and think",
         "To get people to do what he/she wants, he/she often finds it efficient to con them",
         "Sometimes seems to completely lack the capability to feel guilt and remorse",
         "Seems to get bored quickly",
         "Thinks that he/she is better than everyone at almost everything",
         "Never expresses feelings of guilt when he/she has done something not allowed",
         "To frequently lie seems to be completely normal for him/her",
         "Does not express guilt and remorse to the same extent as other children of the same age",
         "Quickly gets tired of things and wants new things to happen all the time")
```

For the comparison of different network structures, use `averageLayout` from `qgraph` package to compute an average layout over several graphs.  

```{r layout1, warnings = FALSE}
L <- averageLayout(Network1,Network2,Network3,Network4)#average layout
```

```{r layout2, warnings = FALSE}
Network1G <- plot(Network1, layout = L,title="Time 1", groups=groups,minimum=0.4,cut=0.4,vsize=8, legend=FALSE,borders=TRUE, palette="colorblind",label.cex=1)#Time 1
Network2G<- plot(Network2, layout = L,title="Time 2", groups=groups,minimum=0.4,cut=0.4,vsize=8, legend=FALSE,borders=TRUE, palette="colorblind",label.cex=1) #Time 2
Network3G <- plot(Network3, layout = L,title="Time 3", groups=groups,minimum=0.4,cut=0.4,vsize=8, legend=FALSE,borders=TRUE, palette="colorblind",label.cex=1) #Time 3
Network4G <- plot(Network4, layout = L,title="Time 4", groups=groups,minimum=0.4,cut=0.4,vsize=8, legend=FALSE,borders=TRUE, palette="colorblind",label.cex=1) #Time 4
```

As seen in the figures, it can be found that:  

+ The orange nodes are items assessed CU traits, the blue nodes are items assessed Grandiose-deceitful, and the green nodes are items assessed Impulsive-Need for Stimulation.    
+ The results of the CPTI network structures were found to be relatively consistent at the four time points, indicating that the network structure was  relatively stable.     

```{r layout3, warnings = FALSE, cache=TRUE, message=FALSE}
pdf("Fig_averagelayoutgraph_T1-T4.pdf", width=10, height=10)
par(mfrow=c(2,2))
Network1G <- plot(Network1, layout = L,title="Time 1", groups=groups,minimum=0.4,cut=0.4,vsize=8, legend=FALSE,borders=TRUE, palette="colorblind",label.cex=1)
Network2G<- plot(Network2, layout = L,title="Time 2", groups=groups,minimum=0.4,cut=0.4,vsize=8, legend=FALSE,borders=TRUE, palette="colorblind",label.cex=1) 
Network3G <- plot(Network3, layout = L,title="Time 3", groups=groups,minimum=0.4,cut=0.4,vsize=8, legend=FALSE,borders=TRUE, palette="colorblind",label.cex=1) 
Network4G <- plot(Network4, layout = L,title="Time 4", groups=groups,minimum=0.4,cut=0.4,vsize=8, legend=FALSE,borders=TRUE, palette="colorblind",label.cex=1) 
dev.off()
```

### 3.2 Network inference: Centrality indices

The basic idea is to first calculate the centrality indices of each nodes in the networks at each time point separately, and then output the visualization results of the centrality indices for comparisons.  

```{r longitudinalcentrality1, warnings = FALSE, cache=TRUE, message=FALSE}
centralityPlot(list(Time1=cor_auto(Data1),
                    Time2 = cor_auto(Data2), Time3=cor_auto(Data3),
                    Time4 = cor_auto(Data4)),
               include=c("Strength","Closeness"),orderBy="Strength")
```

```{r longitudinalcentrality2, warnings = FALSE, cache=TRUE, message=FALSE}
pdf("Fig_centralityPlot_combined_T1-T4.pdf", width=10, height=10)
centralityPlot(list(Time1=cor_auto(Data1),
                    Time2 = cor_auto(Data2), Time3=cor_auto(Data3),
                    Time4 = cor_auto(Data4)),
               include=c("Strength","Closeness"),orderBy="Strength",scale = "z-scores")
dev.off()
```

As shown in the figure, the centrality indices at four time-points were similar. Several items had a greater level of centrality values such as item 15, 20, 21, 25, and 27. It indicated that these items were located in a more central position in the networks.  

### 3.3 The accuracy of networks
The basic idea of this section is to separately analyze the accuracy of the estimated network structure using the data collected at each time point. More details can be found in the example 1.  

### Summary
+ Items assessing a lack of remorse, being unconcerned about others’ feelings, and deceitfulness were positioned centrally with higher centrality indices at each time-point. 
+ The network structure of psychopathy was relatively stable over time. 
+ Our findings extend the knowledge about the core features of child psychopathy and the tendencies of those central characteristics throughout child development. 
+ These findings can help the development of targeted interventions and treatment of child psychopathy in clinical practice.  

### 3.4 Network Comparison Test
Besides, we can also assess the difference between two networks based on several invariance measures.  
+ Cross-time comparison: comparison between different time points, e.g., time point 1 vs. time point 2.  
+ Cross-sample comparison: Comparison between sample characteristics, such as gender, cultural background, sample type, etc.  
- Male network vs. female network  
- Non-Western samples vs. Western samples   
- General sample vs. clinical sample  

#### 3.4.1 Comparison across time-points
This section mainly uses the above demo data to illustrate how to compare network using `NetworkComparisonTest`. Data1 and Data2 are selected as examples to show the network comparison between time 1 and time 2.

```{r NCT1, warnings = FALSE, cache=TRUE, message=FALSE}
compare_12 <- NCT(Data1,Data2, binary.data=FALSE, paired = TRUE,test.edges=TRUE, edges='all', progressbar=TRUE,test.centrality = TRUE,centrality = "strength")#paired:TRUE of FALSE to indicate whether the samples are dependent or not
#centrality：can include multiple centrality indices
```

```{r NCT2, warnings = FALSE, cache=TRUE, message=FALSE}
#compare_12_p.adj <- NCT(Data1,Data2, binary.data=FALSE, paired = TRUE,test.edges=TRUE, edges='all',p.adjust.methods="bonferroni", progressbar=TRUE,test.centrality = TRUE,centrality = "strength")
```

#### (1) NCT topology: network structure invariance test
```{r NCT3, warnings = FALSE, cache=TRUE, message=FALSE}
compare_12$nwinv.pval#p value of the difference in the maximum difference in edge weights
```

#### (2) invariant global strength
```{r NCT5, warnings = FALSE, cache=TRUE, message=FALSE}
compare_12$glstrinv.pval##p value of the difference in global strength
```

#### (3) global strength value estimation
```{r NCT6, warnings = FALSE, cache=TRUE, message=FALSE}
compare_12$glstrinv.sep #value of global strength
```

#### (4) quantification of differences: count significantly different edges 
```{r NCT7, warnings = FALSE, cache=TRUE, message=FALSE}
compare_12$einv.pvals###p value of the difference in edge weights
sum(compare_12$einv.pvals$"p-value" < 0.05)
```

#### (5) differences in centralities: p-value
```{r NCT8, warnings = FALSE, cache=TRUE, message=FALSE}
compare_12$diffcen.pval#p value of the differences in centralities.
sum(compare_12$diffcen.pval< 0.05)
```

It shows that the networks between Data1 and Data2 were similar.  

## 4. Special issues
### 4.1 Missing value
Question 1: Is it possible to handle missing values directly in the packages?  
Question 2: What are the functions to deal with the missing values?  

#### 1. cor_auto()
Add missing parameter for dealing with missing values.

```{r missing1, warnings = FALSE, cache=TRUE, message=FALSE}
library(car)
data1[5,]=car::recode(data1[5,],"1=NA;2=3;3=NA;4=1;else=NA")
sum(is.na(data1))
c1=cor_auto(data1, missing = "pairwise")#using pairwise
q_cor_auto1<-qgraph(c1,groups=ICU24groups,minimum=0.15,cut=0.4,vsize=6,
                   legend=TRUE,borders=TRUE,layout="spring",
                   palette="colorblind",
                   legend.cex=0.15,label.cex=1,
                   labels=Labels,nodeNames=Names, 
                   mar=c(4,1,2,2))
```

#### 2. estimateNetwork()  

```{r missing2, warnings = FALSE, cache=TRUE, message=FALSE}
Network_glasso <- estimateNetwork(data1, default = "EBICglasso",corMethod = "cor_auto",missing="pairwise") # missing include："pairwise", "listwise", "fiml", "stop"
plot(Network_glasso, layout = 'spring',groups=ICU24groups,vsize=6,
                   legend=TRUE,borders=TRUE,
                   palette="colorblind",
                   legend.cex=0.15,label.cex=1,height=5,width=5,
                   labels=Labels,nodeNames=Names, mar=c(4,1,2,2))#建立网络图
```

### 4.2 Types of correlation
+ Determine the corresponding correlation matrix according to the variable type  
+ Automatically calculate the appropriate correlation matrix by using the function `cor_auto`:  
  + continuous variables: Pearson correlation  
  + ordinal variables: polychoric correlation  

From the figure below, it showed that there is little difference between the two types of correlation matrices.  

```{r cor_auto, warnings = FALSE, cache=TRUE, message=FALSE}
library("lavaan")
data(HolzingerSwineford1939)#load data
head(HolzingerSwineford1939)
# Holzinger and Swineford (1939) example 
HS9 <- HolzingerSwineford1939[,c("x1","x2","x3","x4","x5", "x6","x7","x8","x9")]

# Pearson correlations 
qgraph_HS9_pearson<-qgraph(cor_auto(HS9))

# ordinal version, with three categories 
HS9ord <- as.data.frame( lapply(HS9, cut, 3, labels=FALSE) )

# polychoric correlations, two-stage estimation 
cor_auto(HS9ord)
qgraph_HS9_ord<-qgraph(cor_auto(HS9ord))

centralityPlot(list(Pearson=cor_auto(HS9),
                    Ordinal =cor_auto(HS9ord)), 
               include=c("Strength","Closeness"))
```

## 5.Take-away message
+ This tutorial presents how to conduct network analysis, from the basic network to the network comparison across time-points using multiple packages (`qgraph`, `bootnet` and `NetworkComparisonTest`), inclduing network estimation, network inference, network stability and network comparison.    

+ Network analysis has been considered as an alternative approach to investigate the data. It also has some similarites on other statistical techniques, such as how to deal with missing values, outliners and the case of small sample size. Therefore, the analysis might consider the actual situation and research purposes.  

+ Network analysis provides a new perspective in psychopathology for understanding the relationship between mental disorders and symptoms. Future studies might consider this approach in various research areas.   

## 6. Resources
##### 6.1 CRAN R package documentation
As the developer might update the R package, the specific code are subject to the manual with corresponding version.  

```{r help, warnings = FALSE, cache=TRUE, message=FALSE}
help(package="qgraph")#manual
??qgraph
??bootnet
??NetworkComparisonTest
```

##### 6.2 References
*Book*  
[Isvoranu, A.-M., Epskamp, S., Waldorp, L.J., & Borsboom, D. (Eds.). (2022). *Network Psychometrics with R: A Guide for Behavioral and Social Scientists (1st ed.)*. Routledge.](https://doi.org/10.4324/9781003111238)

*Journal*  
[1] Costantini, G., & Epskamp, S. (2017). EstimateGroupNetwork: Perform the joint graphical lasso and selects tuning parameters. R package (Version 0.1.2) [Computer software]. https://cran.r-project.org/web/packages/ EstimateGroupNetwork/index.html  
[2] Epskamp, S., Borsboom, D., & Fried, E. I. (2018). Estimating psychological networks and their accuracy: A tutorial paper. *Behavior Research Methods*, *50*, 195–212. https:// doi: 10.3758/s13428-017-0862-1  
[3] Epskamp, S., Cramer, A. O. J., Waldorp, L. J., Schmittmann, V. D., & Borsboom, D. (2012). qgraph: Network visualizations of relationships in psychometric data. *Journal of Statistical Software*, *48*, 1–18. https://doi.org/10.18637/jss.v048.i04  
[4] van Borkulo, C. D., van Bork, R., Boschloo, L., Kossakowski, J. J., Tio, P., Schoevers, R. A., Borsboom, D., & Waldorp, L. J. (2022). Comparing network structures on three aspects: A permutation test. *Psychological Methods*. Advance online publication. https://doi.org/10.1037/met0000476

